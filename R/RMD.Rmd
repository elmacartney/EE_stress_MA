---
title: "Stress x EE MA"
authors: "Erin L Macartney, Malgorzata Lagisz, Shinichi Nakagawa"
date: "01/07/2021"
output:
  html_document:
    code_folding: hide
    df_print: kable
    toc: TRUE
    toc_float: TRUE
    toc_depth: 4
    collapsed: FALSE
    YAML: rmdformats::robobook
---

#### Loading packages

```{r, message = FALSE, warning = FALSE, results = 'hide'}

knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(tidyverse, 
               here,
               metafor,
               emmeans,
               orchaRd) #orchardRD is used to calculate I2 and R2 

```

#### Loading data and functions

```{r, message = FALSE, warning = FALSE, results = 'hide'}
dat <- read_csv(here("Data","Pilot_data.csv"))
# Load custom function to extract data 
source(here("R/functions.R")) 
```

#### Data organisation
Getting effect sizes from function, 'flipping' effect sizes so that all effect sizes are higher values = individuals do better and learning/memory, and shifting negative values to possitive as lnRR cannot use negative values

```{r, message = FALSE, warning = FALSE, results = 'hide'}

#fixing negative values in study 16 (this doesn't work as can't use 0 in lnRR calculation)
#modifying study 16 that has negative values: shifting everything up by the lowest value
#note, this results in inf lnRR - is it because of the zeros?
#dat1 <- dat %>%
 # rowwise() %>%
  #mutate(min.mean = min(CC_mean, EC_mean, CS_mean, ES_mean)) %>%
  #ungroup() %>%
  #mutate(CC_mean = case_when(First_author == "Wang" ~ CC_mean + abs(min.mean),
                            # TRUE ~ as.numeric(.$CC_mean))) %>%
  #mutate(EC_mean = case_when(First_author == "Wang" ~ EC_mean + abs(min.mean), 
                             #TRUE ~ as.numeric(.$EC_mean))) %>%
  #mutate(CS_mean = case_when(First_author == "Wang" ~ CS_mean + abs(min.mean),
                             #TRUE ~ as.numeric(.$CS_mean))) %>%
  #mutate(ES_mean = case_when(First_author == "Wang" ~ ES_mean + abs(min.mean),
                             #TRUE ~ as.numeric(.$ES_mean)))


#Getting effect sizes
effect_size <- effect_set(CC_n = "CC_n", CC_mean = "CC_mean", CC_SD = "CC_SD",
                          EC_n = "EC_n", EC_mean = "EC_mean" , EC_SD ="EC_SD",
                          CS_n = "CS_n", CS_mean = "CS_mean", CS_SD = "CS_SD",
                          ES_n = "ES_n", ES_mean = "ES_mean", ES_SD = "ES_SD",
                          data = dat)

#Removing missing effect sizes
full_info <- which(complete.cases(effect_size) == TRUE) 
dat_effect <- cbind(dat, effect_size)
dat <- dat_effect[full_info, ]

#Flipping 'lower is better' effect sizes
#flipping lnRR for values where higher = worse
dat$lnRR_Ea <- ifelse(dat$Response_direction == 2, dat$lnRR_E*-1,ifelse(is.na(dat$Response_direction) == TRUE, NA, dat$lnRR_E)) # currently NAswhich causes error
dat$lnRR_Sa  <- ifelse(dat$Response_direction == 2, dat$lnRR_S*-1,ifelse(is.na(dat$Response_direction) == TRUE, NA, dat$lnRR_S)) # currently NAswhich causes error
dat$lnRR_ESa <-  ifelse(dat$Response_direction == 2, dat$lnRR_ES*-1,ifelse(is.na(dat$Response_direction) == TRUE, NA, dat$lnRR_ES)) # currently NAswhich causes error

#flipping SMD
dat$SMD_Ea <- ifelse(dat$Response_direction == 2, dat$SMD_E*-1,ifelse(is.na(dat$Response_direction) == TRUE, NA, dat$SMD_E)) # currently NAswhich causes error
dat$SMD_Sa  <- ifelse(dat$Response_direction == 2, dat$SMD_S*-1,ifelse(is.na(dat$Response_direction) == TRUE, NA, dat$SMD_S)) # currently NAswhich causes error
dat$SMD_ESa <-  ifelse(dat$Response_direction == 2, dat$SMD_ES*-1,ifelse(is.na(dat$Response_direction) == TRUE, NA, dat$SMD_ES))
```

# Modelling with lnRR

## Stress

### Intercept model
Things that remain to be done: 
- Incorporate strain as random effect
- Consider including VCV

Learning and memory are significantly reduced due to stress. 
High heterogeneity
``` {r, message = FALSE, warning = FALSE}
mod_S0 <- rma.mv(yi = lnRR_Sa, V = lnRRV_S, random = list(~1|Study_ID,
                                                          ~1|ES_ID), test = "t", data = dat)

summary(mod_S0) 

i2_ml(mod_S0) 

funnel(mod_S0)

orchard_plot(mod_S0, mod = "Int", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  geom_point(aes(fill = name),  size = 5, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        text = element_text(size = 24), # change font sizes
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 13)) 
```

### Meta-regression
#### Type of learning

``` {r, message = FALSE, warning = FALSE}
dat$Type_learning<-as.factor(dat$Type_learning)

dat <- dat %>% mutate(Type_learning = case_when(Type_learning == 1 ~ "Habituation",
                                                Type_learning == 2 ~ "Conditioning",
                                                Type_learning == 3 ~ "Recognition"))

                               
mod_S1 <- rma.mv(yi = lnRR_Sa, V = lnRRV_S, mod = ~Type_learning-1, random = list(~1|Study_ID,                                                                          ~1|ES_ID),
                 test = "t",
                 data = dat)

summary(mod_S1)

r2_ml(mod_S1) 

# Orchard plot 
orchard_plot(mod_S1, mod = "Type_learning", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  geom_point(aes(fill = name),  size = 5, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        text = element_text(size = 24), # change font sizes
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 13)) 
```

#### Learning vs Memory
``` {r, message = FALSE, warning = FALSE}
dat1<-dat %>% subset(Learning_vs_memory < 3) #remove 3 = unclear
dat1$Learning_vs_memory<-as.factor(dat1$Learning_vs_memory)

dat1 <- dat1 %>% mutate(Learning_vs_memory = case_when(Learning_vs_memory == 1 ~ "Learning",
                                                Learning_vs_memory == 2 ~ "Memory"))

mod_S2 <-  rma.mv(yi = lnRR_Sa, V = lnRRV_S, mod = ~Learning_vs_memory-1, random = list(~1|Study_ID,                                                                                       ~1|ES_ID),
                  test = "t",
                  data = dat1)

summary(mod_S2) #memory but nor learning affected

r2_ml(mod_S2) #marginal R2 is low

# Orchard plot 
orchard_plot(mod_S2, mod = "Learning_vs_memory", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  geom_point(aes(fill = name),  size = 5, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        text = element_text(size = 24), # change font sizes
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 13)) 
```

#### Appetitive vs aversive 

``` {r, message = FALSE, warning = FALSE}
dat2<-  dat %>% subset(Appetitive_vs_aversive < 3) #remove 3 = unclear
dat2$Appetitive_vs_aversive <- as.factor(dat2$Appetitive_vs_aversive)
dat2 <- dat2 %>% mutate(Appetitive_vs_aversive = case_when(Appetitive_vs_aversive == 1 ~ "Appetitive", Appetitive_vs_aversive== 2 ~ "Aversive"))

mod_S3 <- rma.mv(yi = lnRR_Sa, V = lnRRV_S, mod = ~ Appetitive_vs_aversive-1, random = list(~1|Study_ID,                                                                              ~1|ES_ID),
                 test = "t",
                 data = dat2)

summary(mod_S3)
r2_ml(mod_S3) #marginal R2 is low

# Orchard plot 
orchard_plot(mod_S3, mod = "Appetitive_vs_aversive", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  geom_point(aes(fill = name),  size = 5, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        text = element_text(size = 24), # change font sizes
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 13)) 
````

#### Type of stress

``` {r, message = FALSE, warning = FALSE}
dat$Type_stress_exposure <- as.factor(dat$Type_stress_exposure)
dat <- dat %>% mutate(Type_stress_exposure = case_when(Type_stress_exposure == 1 ~ "Density", Type_stress_exposure == 2 ~ "Scent", Type_stress_exposure == 3 ~ "Shock", Type_stress_exposure == 4 ~ "Exertion", Type_stress_exposure == 5 ~ "Restraint", Type_stress_exposure == 6 ~ "MS", Type_stress_exposure == 7 ~ "Circadian rhythm", Type_stress_exposure == 8 ~ "Noise", Type_stress_exposure == 9 ~ "Other", Type_stress_exposure == 10 ~ "Combination", Type_stress_exposure == 11 ~ "unclear"))

mod_S4 <- rma.mv(yi = lnRR_Sa, V = lnRRV_S, mod = ~Type_stress_exposure-1, random = list(~1|Study_ID, ~1|ES_ID),
                 test = "t",
                 data = dat)
summary(mod_S4) #restraint has highest effect on learning and memory
r2_ml(mod_S4)

# Orchard plot 
orchard_plot(mod_S4, mod = "Type_stress_exposure", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  geom_point(aes(fill = name),  size = 5, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        text = element_text(size = 24), # change font sizes
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 13)) 
````

#### Age of stress
Note there are a lot of 'unkown' age as authors only report PND which needs to be researched. I'm wondering if this also needs an 'adolescence' category as this seesm to be popular in rodent research
``` {r, message = FALSE, warning = FALSE}
dat$Age_stress_exposure <-as.factor(dat$Age_stress_exposure)
dat <- dat %>% mutate(Age_stress_exposure = case_when(Age_stress_exposure == 1 ~ "Prenatal", Age_stress_exposure == 2 ~ "Juvenile", Age_stress_exposure == 3 ~ "Adult", Age_stress_exposure == 4 ~ "Unkown"))

mod_S5 <-rma.mv(yi = lnRR_Sa, V = lnRRV_S, mod = ~Age_stress_exposure-1, random = list(~1|Study_ID, 
                                                                                        # ~ 1|Strain, does not run as we have NA
                                                                                        ~1|ES_ID),
                test = "t",
                data = dat)
summary(mod_S5) #unclear is significant. Need to sort out all the ages
r2_ml(mod_S5) #marginal R2 is very high

# Orchard plot 
orchard_plot(mod_S5, mod = "Age_stress_exposure", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  geom_point(aes(fill = name),  size = 5, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        text = element_text(size = 24), # change font sizes
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 13)) 
```
